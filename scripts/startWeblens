#!/bin/bash

if [[ ! -e ./cmd ]]; then
  echo "ERR Could not find ./cmd directory, are you at the root of the repo? i.e. ~/repos/weblens and not ~/repos/weblens/scripts"
  exit 1
fi

if [[ ! -e ./build/bin ]]; then
  mkdir -p ./build/bin
fi

restart=false

while getopts "r" opt; do
  case $opt in
    r) restart=true
    ;;
    \?) echo "Invalid option -$OPTARG" >&2
    exit 1
    ;;
  esac

  case $OPTARG in
    -*) echo "Option $opt needs a valid argument"
    exit 1
    ;;
  esac
done

while true; do
  rm -f ./build/bin/weblens

  go build -gcflags="-N -l" -race -o ./build/bin/weblens ./cmd/weblens/main.go

  if [[ ! -e ./build/bin/weblens ]]; then
    echo "Failed to build Weblens, exiting..."
    exit 1
  fi

  if [[ -z "$CONFIG_NAME" ]]; then
    export CONFIG_NAME=DEBUG-CORE
  fi

  APP_ROOT=$(pwd) ./build/bin/weblens

  if [[ $restart == false ]]; then
    break
  fi
  clear

done

