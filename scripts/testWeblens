#!/bin/bash

if [[ ! -e ./ui ]]; then
  echo "ERR Could not find ./ui directory, are you at the root of the repo? i.e. ~/repos/weblens and not ~/repos/weblens/scripts"
  exit 1
fi

mkdir -p build/logs

remote_tests=false
show_logs=false
ui_tests=false

while [ "${1:-}" != "" ]; do
  case "$1" in
  "-r" | "--remote-tests")
    remote_tests=true
    ;;
  "-l" | "--show-logs")
    show_logs=true
    ;;
  "--ui")
    ui_tests=true
    ;;
  esac
  shift
done

if [[ ! -e ./ui/dist/index.html ]]; then
  cd ui || exit
  export VITE_APP_BUILD_TAG=test
  export VITE_BUILD=true
  npm install
  npm run build
  cd .. || exit
fi

failed=false

if [[ $ui_tests == true ]]; then
  printf "Running UI tests ..."
  cd ui || exit
  if ! npx eslint . &>../build/logs/ui-lint.log; then
    echo " FAIL"
    failed=true
    if [[ $show_logs == true ]]; then
      cat ../build/logs/ui-lint.log
    else
      echo "View eslint logs at \`build/logs/ui-lint.log\` or rerun with --show-log"
    fi
  else
    echo " PASS"
  fi
  cd .. || exit
fi

if [[ $remote_tests == true ]] || [[ $REMOTE_TESTS == true ]]; then
  export REMOTE_TESTS=true
  echo "Setting up remote tests ..."
  if ! source ./scripts/setupRemoteTests; then
    echo "ERR Failed to setup remote tests, not running tests"
    exit 1
  fi
fi

target=$1
if [[ -z "$target" ]]; then
  target="./..."
fi

printf "Running backend tests ..."
if ! (
  set -o pipefail
  APP_ROOT=$PWD CONFIG_PATH=$PWD/config CONFIG_NAME=TEST go test -v "$target" &>./build/logs/backend-test.log
); then
  echo " FAIL"
  failed=true
  if [[ $show_logs == true ]]; then
    grep -v -e CONT -e PAUSE <./build/logs/backend-test.log | grep --color=always -e "^" -e "FAIL" | GREP_COLOR="1;32" grep --color=always -e "^" -e "PASS"
  else
    echo "View go test logs at \`build/logs/backend-test.log\` or rerun with --show-log"
  fi
else
  echo " PASS"
fi

if [[ $failed == true ]]; then
  exit 1
fi
